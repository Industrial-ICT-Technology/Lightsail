{% extends 'base.html' %} {% load static %} {% block style %}
<link rel="stylesheet" href="{% static '../static/dashboard/css/dashboard.css' %}?after" />
{% endblock %} {% block content-title %}
{% endblock %} {% block content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://d3js.org/d3.v6.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/d3-hierarchy@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-format@2.2.3"></script>

<style>
  
</style>
  <div class="first-desc-wrap">
    <form style="display: inline-block" action="" method="get" name="category_product">
      {% csrf_token %}
      <p class="subject fw-400 fs-base">제품 선택</p>
      <select name="category_product" id="product_select_status">
        {% if selected %}
          <option value="{{ selected }}" selected>{{ selected }}</option>
        {% else %}
          <option value="--제품을 선택하세요--" selected>제품이름을 선택하세요</option>
        {% endif %}
          {% for product_name in product_names %}
            <option value="{{ product_name.category_product }}"
              {% if forloop.first %} selected {% endif %}>
              {{ product_name.category_product }}
            </option>
          {% endfor %}
        
      </select>
    </form>
    
    <form style="display: inline-block" action="" method="get"  name="category_model_name">
      {% csrf_token %}
      <select name="category_model_name" id="model_name_select_status">
        {% if selected_name %}
          <option value="{{ selected_name }}" selected>{{ selected_name }}</option>
        {% else %}
          <option value="--모델명을 선택하세요--" selected>모델이름을 선택하세요</option>
        {% endif %}
        {% for model_name in model_names %}
    
        {% if model_name.model_name %}
          {% if model_name.model_name != "nan" %}
            <option value={"{{ model_name.model_name }},{{selected}}"}>
              {{ model_name.model_name }}
            </option>
          {% endif %}
        {% endif %}
          {% endfor %}
      </select>
    </form>

    <form style="display: inline-block" action="" method="get" name="category_model_code">
      {% csrf_token %}
      <select name="category_model_code" id="model_code_select_status">
        {% if selected_code %}
          <option value="{{ selected_code }}" selected>{{ selected_code }}</option>
        {% else %}
          <option value="--모델명을 선택하세요--" selected>모델코드를 선택하세요</option>
        {% endif %}
        {% for model_code in model_codes %}
    
        {% if model_code.model_code %}
          {% if model_code.model_code != "nan" %}
            <option value={"{{ model_code.model_code }},{{selected}},{{selected_name}}"}>
              {{ model_code.model_code }}
            </option>
          {% endif %}
        {% endif %}
          {% endfor %}
      </select>
    </form>
    <script> // 제품 선택
      document.addEventListener("DOMContentLoaded", function() {
        var select = document.getElementById("product_select_status");
        var storedValue = localStorage.getItem("product_select_status");
        if (storedValue) {
          select.value = storedValue;
        }
        select.addEventListener("change", function() {
          localStorage.setItem("product_select_status", this.value);
        });
      });
    
      
      $(document).ready(function() {
        $('#product_select_status').change(function() {
          $('form[name="category_product"]').submit();
        });
        $('#model_name_select_status').change(function() {
          $('form[name="category_model_name"]').submit();
        });
        $('#model_code_select_status').change(function() {
          $('form[name="category_model_code"]').submit();
        });
      });
    </script>
    <div class="dashboard wrap1">
      <div class = "category_apply">
        <h3 class="apply_text">카테고리</h3>
        <form id="checked-data-form" action="{% url 'dashboard:dashboard' %}" method="post">
          {% csrf_token %}
          <div class="apply_box">
              {% for category_detail_list, positive, negative, neutral, everything,order in data %}
              <div class="category_item">
                  <div class="apply_on">
                      <label class="switch">
                          <input type="checkbox" name="checked_data[]" value="{{ category_detail_list }}">
                          <input type="hidden" name="showing_index" value="{{ order }}" >
                          <span class="slider round"></span>
                      </label>
                  </div>
                  <div class="apply_main">
                      <div>{{ category_detail_list }}</div>
                  </div>
              </div>
              {% endfor %}
          </div>
          <button type="submit">적용하기</button>
        </form>
      </div>
      <div class= "isNagative">
      </div>
      <div class ="rawdata">
      </div>
    </div>
    <div class="dashboard wrap2">
      <div class="frequency">
        <h3 class ="frequency_text">카테고리별 빈도</h3>
        <div class="frequency_box width="500px height="230px">
          
          <div id="treemap" width="500px"height="230px"></div>
          
        </div>
      </div>
      <div class="rank">
      </div>
    </div>
    <div class="dashboard wrap3">
      <div class="category_ratio">
        <h3 class="category_ratio_text">카테고리별 긍정/부정</h3>
        <div class="category_ratio_box">
          <canvas id="ratio_category" width="500px"height="230px"></canvas>
        </div>
      </div>
      <div class="ratio1">
        <h3 class="ratio1_text">긍/부정 비율</h3>
        <div class="ratio1_box">
          <div class="canvas-container">
            <canvas id="ratio" height="230px"></canvas>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script>

     

      //  누적막대그래프
      const category_detail_list = {{ category_detail_list|safe }};
      const results_positive = {{ results_positive|safe }};
      const results_negative = {{ results_negative|safe }};
      const results_neutral = {{ results_neutral|safe }};

      let stackedDataset = [
        {
          label: 'Positive',
          data: results_positive,
          backgroundColor: '#1f77b4'
        },
        {
          label: 'Negative',
          data: results_negative,
          backgroundColor: '#d62728'
        },
        {
          label: 'Neutral',
          data: results_neutral,
          backgroundColor: '#7f7f7f'
        }
      ];
            
      
      new Chart(document.getElementById("ratio_category"), {
        type: 'bar',
        data: {
          labels: category_detail_list,
          datasets: stackedDataset
        },
        options: {
          scales: {
            x: {
              stacked: true
            },
            y: {
              stacked: true
            }
          }
        }
      });

      //도넛형 그래프
      
      let positiveSum = results_positive.reduce((a, b) => a + b, 0);
      let negativeSum = results_negative.reduce((a, b) => a + b, 0);
      let neutralSum = results_neutral.reduce((a, b) => a + b, 0);
      
      
      let ctx = document.getElementById("ratio").getContext("2d");
      let pieChart = new Chart(ctx, {
        type: "doughnut", 

        data: {
          labels: ["Positive", "Negative", "Neutral"],
          datasets: [
            {
              data: [positiveSum, negativeSum, neutralSum],
              backgroundColor: ["#1f77b4", "#d62728", "#7f7f7f"],
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { display: false },
            y: { display: false }
          },
          plugins: {
            legend: false
          }
        }
      });
    </script>
  </div>
{% endblock %}
